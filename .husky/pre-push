#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push validation..."

# Lint modified client source files (exclude deleted, config, test, style files)
MODIFIED_CLIENT_FILES=$(git diff --name-only --diff-filter=ACMR HEAD | grep "^client/src/.*\.\(ts\|vue\)$" | grep -v "\.test\.ts$" | grep -v "\.spec\.ts$" | grep -v "\.css$" | sed 's|^client/||' || true)
if [ -n "$MODIFIED_CLIENT_FILES" ]; then
  echo "ğŸ“ Linting modified client files..."
  cd client
  echo "$MODIFIED_CLIENT_FILES" | tr '\n' ' ' | xargs pnpm eslint --max-warnings 0 || {
    echo "âŒ Client linting failed. Please fix the errors above."
    exit 1
  }
  cd ..
else
  echo "â„¹ï¸  No client files to lint"
fi

# Lint modified server source files (exclude deleted files and tests)
MODIFIED_SERVER_FILES=$(git diff --name-only --diff-filter=ACMR HEAD | grep "^server/src/.*\.\(ts\)$" | grep -v "\.test\.ts$" | grep -v "\.spec\.ts$" | sed 's|^server/||' || true)
if [ -n "$MODIFIED_SERVER_FILES" ]; then
  echo "ğŸ“ Linting modified server files..."
  cd server
  echo "$MODIFIED_SERVER_FILES" | tr '\n' ' ' | xargs pnpm eslint --max-warnings 0 || {
    echo "âŒ Server linting failed. Please fix the errors above."
    exit 1
  }
  cd ..
else
  echo "â„¹ï¸  No server files to lint"
fi

# Run format check
echo "ğŸ’… Checking code formatting..."
pnpm format:check || {
  echo "âŒ Code formatting check failed. Run 'pnpm format' to fix."
  exit 1
}

# Run typecheck on all code
echo "ğŸ” Running typecheck..."
pnpm typecheck || {
  echo "âŒ Type check failed. Please fix the type errors above."
  exit 1
}

# Run unit tests
echo "ğŸ§ª Running tests..."
pnpm test:unit || {
  echo "âŒ Tests failed. Please fix the failing tests above."
  exit 1
}

# Build the project (this will run vue-tsc again + vite build)
echo "ğŸ”¨ Building project..."
pnpm build || {
  echo "âŒ Build failed. Please fix the build errors above."
  echo "ğŸ’¡ Tip: Run 'pnpm build' locally to catch build errors before pushing."
  exit 1
}

echo "âœ… Pre-push validation passed! All checks completed successfully."